<!doctype html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title>Food Oasis Los Angeles</title>
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Reem+Kufi|Open+Sans" />
	<link rel="stylesheet" href="/assets/leaflet/leaflet.css" />
	<link rel="stylesheet" href="/assets/css/oasis.css" />

	<!-- Need the following files to enable Mapbox -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.3.0/mapbox-gl-geocoder.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.3.0/mapbox-gl-geocoder.css' type='text/css' />

    <script>
		// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript#answer-901144
		function getParameterByName(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
					results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
	</script>
</head>
<body class="map">
	<div class="header">
		<h2>
			<a href="/navigation">
				<img src="/assets/images/food-oasis-la-horizontal.svg" width="300" alt="Food Oasis Los Angeles" />
			</a>
		</h2>
	</div>
	<nav>
		<ul>
			<li>
				<a href="/">
					<!--
					Search icon
					by Veronika Krpciarova
					https://thenounproject.com/v.krpciarova/collection/search/?oq=search&cidx=1&i=353178
					-->
					<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20">
						<path fill="#FFFFFF" d=" M 83.7 77.7 Q 83.6751953125 77.5302734375 83.55 77.4 L 62.65 54.95 Q 67.4498046875 48.480859375 67.45 40 67.44765625 29.3423828125 59.85 21.75 52.3580078125 14.252734375 41.7 14.25 31.0427734375 14.2533203125 23.45 21.75 15.9533203125 29.3427734375 15.95 40 15.952734375 50.6580078125 23.45 58.15 31.0423828125 65.74765625 41.7 65.75 48.7376953125 65.747265625 54.45 62.45 L 76.15 85.5 Q 76.26796875 85.6412109375 76.4 85.7 76.5693359375 85.7599609375 76.7 85.75 81.1939453125 85.53125 82.9 83.5 84.7708984375 81.51328125 83.7 77.7 M 51.75 29.9 Q 55.9521484375 34.107421875 55.95 40 55.9521484375 45.8923828125 51.75 50.05 47.5923828125 54.2521484375 41.7 54.25 35.807421875 54.2521484375 31.6 50.05 27.44765625 45.8923828125 27.45 40 27.44765625 34.107421875 31.6 29.9 35.807421875 25.74765625 41.7 25.75 47.5923828125 25.74765625 51.75 29.9 Z"></path>
					</svg>
					<span>Find food near you</span>
				</a>
			</li>
		</ul>
	</nav>

	<form action="/map" method="get">
		<div>
			<h1>Find food near you</h1>
			<p>
				<label>
					<span>Address, Neighborhood, or Zip</span><br />
					<input type="text" name="address" placeholder="125 Fruitland Avenue" />
				</label>
				<button type="submit">Go</button>
			</p>
		</div>
	</form>
	<script>
		var addressField = document.querySelector('input[name="address"]');

		function addressAvailable() {
			return addressField && addressField.value != null && addressField.value != '';
		}

		(function() {
			// Persist the address, if it was passed to this page
			var addressField = document.querySelector('input[name="address"]');
			var address = getParameterByName('address');

			if (address && addressField) {
				addressField.value = address;
			}

			/*
			function addCityToAdddress() {
				if (addressAvailable() && addressField.value.indexOf('Los Angeles') < 0) {
					addressField.value = addressField.value + ', Los Angeles';
				}
			}
			*/
			//addCityToAdddress();

			/*
			var form = document.querySelector('form');
			form.addEventListener('submit', function(e) {
				if (window.moveMapToAddress) {
					addCityToAdddress();
					window.moveMapToAddress()
					e.preventDefault();
					document.getElementById('map').scrollIntoView(false);
				}
			});
			*/
		})();
	</script>

	<div id="map" class="mapbox"></div>

	<!-- Jim’s Google Maps API key -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP5KxqO9v1sLhXlkrG3vDiDdOJvYLJ0H4"></script

	<script src="/assets/leaflet/leaflet.js"></script>
	<script>

		mapboxgl.accessToken = 'pk.eyJ1IjoiZm9vZGRlc2VydHNsYSIsImEiOiJjaXByOXRscnMwNzY1Zm5ub3YwYTd5Z3dsIn0.DWgUhgW32pVkybKx7cWWiw';

		var bounds = [
			[-119.9442369,32.7089729], // Southwest coordinates
			[-116.63282912,35.8275538]  // Northeast coordinates
		];

		var map = new mapboxgl.Map({
			container: 'map', // container id
			//style: 'mapbox://styles/fooddesertsla/ciqlgjsvb0001bkno0wkx8gg8', // stylesheet location
			style: 'mapbox://styles/fooddesertsla/cirso6vli0009gam85y4z56xz', // Jim’s test stylesheet location
			center: [-118.243683, 34.052235], // starting position
			zoom: 13, // starting zoom
			maxBounds: bounds
		});

		// Add Search Functionality
		//map.addControl(new mapboxgl.Geocoder());	

		var nav = new mapboxgl.Navigation({position: 'bottom-left'}); // position is optional
		map.addControl(nav);

		// Add 'Current Location' Functionality
		map.addControl(new mapboxgl.Geolocate());

		// Create a popup, but don't add it to the map yet.
		var popup = new mapboxgl.Popup({
			closeButton: false,
			closeOnClick: false
		});
	
		// Creates a popup on hover
		map.on('click', function(e) {
			var features = map.queryRenderedFeatures(e.point, { layers: ['Food Banks (Solution)','CG-UF-N (Solution)','Farmers Markets (Solution)','Groceries (Problem)'] });

			// Change the cursor style as a UI indicator.
			map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
			if (!features.length) {
				popup.remove();
				return;
			}

			var feature = features[0];

			// Name
			var name = 	feature.properties["name"] || 
						feature.properties["Name"] ||
						feature.properties["NAME"] ||
						feature.properties["NAME:"] ||
						feature.properties["MarketName"];

			// Hours
			var hours = feature.properties["times"] ||
						feature.properties["Times"] ||
						feature.properties["TIMES"] ||
						feature.properties["TIMES:"];

			// Phone
			var telephone = feature.properties["telephone"] ||
							feature.properties["Telephone"] ||
							feature.properties["CONTACT"] ||
							feature.properties["CONTACT:"];

			// Address
			var address = "";
			var street = 	feature.properties["address"] ||
							feature.properties["Address"] ||
							feature.properties["ADDRESS"] ||
							feature.properties["ADDRESS:"];
			var city = 	feature.properties["city"] ||
						feature.properties["City"];
			var state = feature.properties["state"] ||
						feature.properties["State"];
			if (street) address += street;
			if (city) address += (street ? '<br />' : '') + city;
			if (state) address += (city ? ', ' : (street ? '<br />' : '')) + state;

			// TEMPORARY: Only show links to food banks (since the /source/ pages are only generated for food banks presently).
			var showLink = (feature.layer.id === 'Food Banks (Solution)') ? true : false;

			var html = [];

			html.push('<div class="map-point-details">');

			if (name && showLink) {
				var uri = name.toLowerCase().replace(/\s/g, '-')
											.replace(/\//g, '-')
											.replace(/\&/g, '-')
											.replace(/\./g, '-')
											.replace(/\'/g, '')
											.replace(/\-\-/g, '-')
				html.push('<h3><a href="/source/' + uri + '/">' + name + '</a></h3>');
			} else if (name) {
				html.push('<h3>' + name + '</h3>');
			}
			if (address) {
				html.push('<p>' + address + '</p>');
			}
			if (telephone) {
				html.push('<p>' + telephone + '</p>');
			}
			// html.push("<p>"+feature.properties["CONTACT"]+"</p>");
			if (hours) {
				html.push('<h4>Hours</h4>');
				html.push('<p class="hours">' + hours + '</p>');
			}

			html.push('</div>');

			//console.log(feature);//Displays the contents as an array in the console log

			popup.setLngLat(feature.geometry.coordinates).setHTML(html.join('')).addTo(map);
		}); 

		function geocodeAddress(address, callback) {
			var geocoder = new google.maps.Geocoder();

			geocoder.geocode({'address': address}, function(results, status) {
				if (status === google.maps.GeocoderStatus.OK) {

					var longitude = results[0].geometry.location.lng();
					var latitude  = results[0].geometry.location.lat();

					// console.log('longitude: ' + longitude);
					// console.log('latitude: ' + latitude);

					callback([longitude, latitude]);

				} else {
					console.error('Geocode was not successful for the following reason: ' + status);
				}
			});
		}

		function moveMapToPosition(position) {
			 map.setZoom(14);
			 map.panTo(position);

			var marker = document.createElement('div');
			marker.className = 'marker';

			var img = document.createElement('img');
			img.className = 'icon';
			img.src = '/assets/images/markers/purple.svg';
			marker.appendChild(img);

			/*
			var label = document.createElement('span');
			label.className = 'label';
			label.innerText = 'You are here' //addressField.value;
			marker.appendChild(label);
			*/

			new mapboxgl.Marker(marker)
				.setLngLat(position)
				.addTo(map);
		}

		var address = getParameterByName('address');

		if (address) {
			if (address.indexOf('Los Angeles') < 0) {
				address += ' Los Angeles';
			}
			geocodeAddress(address, moveMapToPosition);

		// Grab user's location on page-load
		} else if ("geolocation" in navigator) {
			navigator.geolocation.getCurrentPosition(function(position) {

				// Set new starting location
				var myCoords = [position.coords.longitude, position.coords.latitude];
				moveMapToPosition(myCoords)

				/*
				// Place a current location marker
				while (map.getCenter().toArray() == myCoords) {
					// map.on('load', function () {
					//     map.addSource("points", {
					//         "type": "geojson",
					//         "data": {
					//             "type": "FeatureCollection",
					//             "features": [{
					//                 "type": "Feature",
					//                 "geometry": {
					//                     "type": "Point",
					//                     "coordinates": myCoords
					//                 },
					//                 "properties": {
					//                     "title": "My Location",
					//                     "icon": mymarker
					//                 }
					//             }]
					//         }
					//     });

					//     map.addLayer({
					//         "id": "points",
					//         "type": "symbol",
					//         "source": "points",
					//         "layout": {
					//             "icon-image": "{icon}",
					//             "text-field": "{title}",
					//             "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
					//             //"text-color": "#ffff00",
					//             //"text-opacity": 0.75,
					//             "text-offset": [0, 0.75],
					//             "text-anchor": "top"
					//         }
					//     });
					// });
				}
				*/

				/*
				function showPosition(position) {
					//x.innerHTML = "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude; 

				    myLat = position.coords.latitude;
				    myLon = position.coords.longitude;
				};
				*/
			}, function() {
				console.error("Unable to retrieve your location");
			});
		}

	</script>
	
</body>
</html>
