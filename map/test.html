<!doctype html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title>Map, Food Oasis Los Angeles</title>
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Reem+Kufi|Open+Sans" />
	<link rel="stylesheet" href="/assets/css/oasis.css" />

	<!-- For Mapbox -->
	<link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.22.0/mapbox-gl.css" />

	<style>
	.map-filters {
		position: absolute;
		z-index: 1;
		top: 7.25rem; /* header height + 1.5rem */
		left: 1.5rem;
		width: 15em;
	}

	@media (min-width: 30em) {
		.map-filters {
			top: 8.75rem; /* header height + 3rem */
			left: 3rem;
		}
	}

	.map-filters .food-bank {
		background-color: rgb(249, 192, 88); /* @banana */
	}
	.map-filters .community-garden {
		background-color: rgb(144, 194, 70); /* @lime */
	}
	.map-filters .farmers-market {
		background-color: rgb(241, 95, 91); /* @strawberry */
	}
	.map-filters .grocery-store {
		background-color: rgb(77, 85, 148); /* @blueberry */
	}

	.map-filters .inactive {
		opacity: 0.5;
	}

	@media (max-width: 35em) and (max-height: 35em) {
		.map-filters {
			display: none;
		}
	}
	</style>
</head>
<body class="map">

	<div class="header">
	<h2>
		<a href="/">
			<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="300" height="38" viewBox="0 0 983.6 123.7">
				<switch>
					<g>
						<g class="food-oasis">
							<path fill="#90C246" d="M138.4,60.6c-0.1,7.8-1.7,15.2-5.7,22c-3.9,6.6-9.5,11.3-16.4,14.4c-5.4,2.4-11.1,3.7-17,4
								c-9.4,0.5-18.3-1.2-26.5-5.8c-10.4-5.9-17.1-14.6-19.4-26.5c-1.2-6.5-1-13,1.8-19.2c1.4-3.2,3.4-6.1,5.9-8.6
								c3.7-3.6,8-4.2,12.8-2.5c3.4,1.2,6.6,2.9,9.3,5.4c4.6,4.2,10.2,5.4,16.2,5c4.2-0.2,7.7-1.8,10.8-4.6c1.6-1.4,2.7-3.1,3.8-4.9
								c1.1-1.9,2.6-3.3,4.9-3.6c1.4-0.2,2.7,0.2,4.1,0.6c5.5,1.7,9.4,5.4,12.2,10.3C137.5,51,138.5,55.6,138.4,60.6z"/>
							<path fill="#90C246" d="M100.5,37.4c0,2.5-0.1,4.2-0.7,5.8c-0.9,2.4-3.1,3.4-5.5,2.6c-2-0.7-2.6-2.3-2.8-4.2
								c-0.2-2,0.1-3.9,0.6-5.8c1-3.7,0.9-7.5,0.2-11.2c-0.2-1.3,0.2-2.1,1.4-2.4c1-0.3,2-0.3,3,0.1c0.7,0.3,1.3,0.8,1.5,1.6
								c0.6,2.9,1.3,5.8,1.8,8.7C100.3,34.4,100.4,36.3,100.5,37.4z"/>
							<path fill="#90C246" d="M103.2,45c1.3-3.5,1.2-7,0.9-10.5c0-0.4,0.1-0.7,0.4-1c3.7-3.1,7-6.6,9.6-10.7
								c0.5-0.8,1-1.7,1.6-2.5c-0.4,1.7-0.8,3.4-1.3,5.1c-1.3,4.8-2.9,9.6-5.5,13.9c-1.2,2-2.6,3.8-4.5,5C104,44.6,103.6,44.8,103.2,45z"
								/>
							<path fill="#90C246" d="M87.8,42.7c-1.4-1.3-2.8-2.5-4.3-3.8c-3.3-2.8-6.9-5.4-11.1-6.7c-1.5-0.5-3.2-0.7-4.7-1.1
								c7.1-0.8,14.1-0.3,20.9,2.8c-0.7,2.9-1.1,5.8-0.6,8.7C87.9,42.7,87.8,42.7,87.8,42.7z"/>
							<polygon fill="#90C246" points="0,102.9 0,37 48,37 48,49 12.6,49 12.6,67 46.1,67 46.1,78.5 12.6,78.5 
								12.6,102.9 	"/>
							<path fill="#90C246" d="M156.7,70.6C157,81.4,162.8,93,178.4,93c15.5,0,21.4-11.7,21.6-22.5
								c0.2-11.1-6-23.5-21.6-23.5C162.9,46.9,156.5,59.5,156.7,70.6 M212.2,70.3c-0.2,17-10.6,34.1-33.8,34.1s-33.9-16.7-33.9-34
								s11.1-34.7,33.9-34.7C201.1,35.7,212.4,53.1,212.2,70.3"/>
							<path fill="#90C246" d="M230.6,90.9h13.6c15,0,21-10.9,20.7-21.7c-0.3-10.3-6.3-20.5-20.7-20.5h-13.6L230.6,90.9
								L230.6,90.9z M277.3,69.3c0.3,16.7-9.9,33.5-33.1,33.5h-26v-66h26C266.9,36.9,277,53,277.3,69.3"/>
							<path fill="#90C246" d="M311,70.6c0.3,10.8,6.1,22.4,21.7,22.4c15.5,0,21.4-11.7,21.6-22.5
								c0.2-11.1-6-23.5-21.6-23.5C317.2,46.9,310.8,59.5,311,70.6 M366.5,70.3c-0.2,17-10.6,34.1-33.8,34.1c-23.2,0-33.9-16.7-33.9-34
								s11.1-34.7,33.9-34.7C355.4,35.7,366.7,53.1,366.5,70.3"/>
							<path fill="#90C246" d="M403,50.8l-12.4,28.1h24.8L403,50.8z M420.4,90.5h-34.9l-5.7,12.4h-13.6l30-66h13.7l30,66
								h-13.7L420.4,90.5z"/>
							<path fill="#90C246" d="M568.2,52.9c-2.3-3.8-8.6-7.3-15.8-7.3
								c-9.3,0-13.8,3.9-13.8,8.7c0,5.7,6.9,7.3,14.8,8.3c13.9,1.7,26.8,5.3,26.8,21c0,14.7-13.1,21-28,21c-13.6,0-24.1-4.1-29-16.2
								l10.5-5.4c3,7.2,10.7,10.4,18.8,10.4c7.9,0,15.3-2.7,15.3-9.9c0-6.2-6.6-8.7-15.4-9.7c-13.6-1.6-26.2-5.2-26.2-19.9
								c0-13.5,13.5-19.1,25.8-19.2c10.4,0,21.1,2.9,26.2,13.1L568.2,52.9z"/>
							<rect x="502.1" y="36.9" fill="#90C246" width="14" height="66"/>
							<path fill="#90C246" d="M482.7,52.9c-2.3-3.8-8.6-7.3-15.8-7.3c-9.3,0-13.8,3.9-13.8,8.7c0,5.7,6.9,7.3,14.8,8.3
								c13.9,1.7,26.8,5.3,26.8,21c0,14.7-13.1,21-28,21c-13.6,0-24.1-4.1-29-16.2l10.5-5.4c3,7.2,10.7,10.4,18.8,10.4
								c7.9,0,15.3-2.7,15.3-9.9c0-6.2-6.6-8.7-15.4-9.7c-13.6-1.6-26.2-5.2-26.2-19.9c0-13.5,13.5-19.1,25.8-19.2
								c10.4,0,21.1,2.9,26.2,13.1L482.7,52.9z"/>

							<path fill="#90C246" d="M524.2,13.5c-4.9,0.8-9,3.3-11.9,6.7C515.5,4,524.6,4.9,523.7,4.4c-6.6-3.7-15.9,1.2-20.9,9.6
								c-2.5-2-5.7-3.5-9.2-4.1c-10-1.6-20.1,4.4-20.5,13.2c0,1.2,4.5-9.3,21.7,0.5c-0.8,0.1-1.6,0.2-2.4,0.4c-6.7,1.9-11.4,9-9.2,15
								c0.3,0.8,0.2-7.9,14.8-6.1c0.4,0.1,0.9,0.2,1.5,0.4c-0.1,0.1-0.2,0.2-0.3,0.4c-0.8,1.3-0.9,3.3-1.3,4.9c0.1,2.9,2.7,5.4,5.5,5.4
								c1.9-0.1,3.6-1.4,4.2-3.3c0,0,0.1,0,0.1,0.1c2.9,1.2,4.2,0.3,4.6-1.6c2-0.5,4.3-1.4,5.6-1.4c14.1-0.2,11.1,9.8,11.6,8.8
								c4.1-6.6,2.2-15.3-3.4-18.3c-1-0.6-2.2-0.9-3.3-1c17.4-9.9,21.9,0.6,21.9-0.6C544.3,17.9,534.2,11.9,524.2,13.5z"/>
						</g>

						<g class="los-angeles">
							<path fill="#333333" d="M636.3,58.1l-6.6,37.6h23.4l-1.4,7.9h-32l8-45.5H636.3z"/>
							<path fill="#333333" d="M691.8,87.6c-1.6,9.2-9.3,16.7-19.7,16.7s-15.3-7.5-13.7-16.7s9.3-16.7,19.5-16.7
								S693.5,78.4,691.8,87.6z M666.4,87.6c-0.9,4.9,1.3,9.4,7,9.4s9.5-4.6,10.4-9.4c0.8-4.8-1.7-9.5-7-9.5
								C671.1,78.1,667.3,82.8,666.4,87.6z"/>
							<path fill="#333333" d="M719.6,80c-1.9-2.1-4.4-2.9-7.4-2.9c-3.8,0-6.1,1.2-6.4,3.2c-0.4,2.1,1.3,3.3,5.4,3.5
								c6,0.4,13.4,1.8,11.9,10.3c-1,5.7-6.5,10.5-15.6,10.5c-5.1,0-10-0.8-13.8-5.7l4.9-5.7c1.8,2.5,6.7,4.4,10.3,4.5
								c3,0.1,6-1.5,6.5-3.8c0.4-2.2-1.3-3.1-5.8-3.4c-6-0.5-12.8-2.7-11.5-9.9c1.3-7.4,9.4-10,15.3-10c5,0,8.6,1,11.7,4.2L719.6,80z"/>
							<path fill="#333333" d="M773.9,95h-23.8l-5.4,8.6h-9.3l28.4-45.5h9.4l12.4,45.5h-9.4L773.9,95z M766.9,67.6
								L755,87h16.9L766.9,67.6z"/>
							<path fill="#333333" d="M811.8,103.6l3-16.8c0.9-4.9-1.2-8.6-6.2-8.6c-4.9,0-8.9,4.1-9.8,9l-2.9,16.4H788
								l5.7-32.1h7.1l-0.2,4.4c3.8-3.2,7.3-4.8,11.4-4.8c7.5,0,12.6,5.7,10.8,15.7l-3,16.8L811.8,103.6L811.8,103.6z"/>
							<path fill="#333333" d="M857.9,68.3l5.1,4.4l-4.4,4.6c2,2.8,2.3,6,1.7,9.5c-0.7,4-3.2,9.6-8.9,12
								c4.9,2.7,5.5,6.5,4.8,10.6c-1.6,8.8-9.3,14.3-18.6,14.3s-15.3-5.7-13.7-14.3h7.9c-0.7,4.2,2.6,6.9,7.2,6.9c4.6,0,8.6-2.5,9.3-6.9
								c0.8-4.4-3-6.4-7-6.4c-10,0-15.2-6.1-13.4-16.1S838,70.6,847,70.6c2.5,0,5.1,0.3,7,1.8L857.9,68.3z M835.8,86.7
								c-1,5.6,2.2,8.9,6.8,8.9c4.5,0,8.9-3.4,9.9-8.9s-2.2-9-6.7-9C841.1,77.7,836.8,81.2,835.8,86.7z"/>
							<path fill="#333333" d="M871.5,90.4c-0.2,4,2.8,6.8,8.4,6.8c2.9,0,7-1.1,9.1-3l4.2,5c-4,3.5-9.8,5.2-14.7,5.2
								c-11.1,0-16.4-6.8-14.6-17.1c1.7-9.8,9.6-16.8,20-16.8c10.7,0,16.3,6.6,12.7,19.8L871.5,90.4L871.5,90.4z M890.1,83.8
								c0.2-4.2-2.7-6.2-7.2-6.2c-4.3,0-8.2,2.1-10.1,6.2H890.1z"/>
							<path fill="#333333" d="M916.2,58.1l-8,45.4h-7.9l8-45.4H916.2z"/>
							<path fill="#333333" d="M924.2,90.4c-0.2,4,2.8,6.8,8.4,6.8c2.9,0,7-1.1,9.1-3l4.2,5c-4,3.5-9.8,5.2-14.7,5.2
								c-11.1,0-16.4-6.8-14.6-17.1c1.7-9.8,9.6-16.8,20-16.8c10.7,0,16.3,6.6,12.7,19.8L924.2,90.4L924.2,90.4z M942.8,83.8
								c0.2-4.2-2.7-6.2-7.2-6.2c-4.3,0-8.2,2.1-10.1,6.2H942.8z"/>
							<path fill="#333333" d="M978.1,80c-1.9-2.1-4.4-2.9-7.4-2.9c-3.8,0-6.1,1.2-6.4,3.2c-0.4,2.1,1.3,3.3,5.4,3.5
								c6,0.4,13.4,1.8,11.9,10.3c-1,5.7-6.5,10.5-15.6,10.5c-5.1,0-10-0.8-13.8-5.7l4.9-5.7c1.8,2.5,6.7,4.4,10.3,4.5
								c3,0.1,6-1.5,6.5-3.8c0.4-2.2-1.3-3.1-5.8-3.4c-6-0.5-12.8-2.7-11.5-9.9c1.3-7.4,9.4-10,15.3-10c5,0,8.6,1,11.7,4.2L978.1,80z"/>
						</g>
					<g>
					<foreignobject>Food Oasis Los Angeles</foreignobject>
				</switch>
			</svg>
		</a>
		<!--
		<div class="dropdown"> 
			<button onclick="dropDownFunction()" class="dropbtn">Menu</button>
			<div id="myDropdown" class="dropdown-content">
				<a href="/map">Map</a>
				<a href="/source">Food banks</a>
				<a href="/faqs"><abbr title="Frequently Asked Questions">FAQs</abbr></a>
				<a href="/resources">Resources</a>
				<a href="/news">News</a>
			</div>
		</div>
		-->
	</h2>
	<!--
	<script type="text/javascript">
		function dropDownFunction() {
	    	document.getElementById("myDropdown").classList.toggle("show");
		}
	</script>
	-->
</div>

	<nav>
	<p>
		<a href="/">
			<!--
			Search icon
			by Veronika Krpciarova
			https://thenounproject.com/v.krpciarova/collection/search/?oq=search&cidx=1&i=353178
			-->
			<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20">
				<path fill="#FFFFFF" d=" M 83.7 77.7 Q 83.6751953125 77.5302734375 83.55 77.4 L 62.65 54.95 Q 67.4498046875 48.480859375 67.45 40 67.44765625 29.3423828125 59.85 21.75 52.3580078125 14.252734375 41.7 14.25 31.0427734375 14.2533203125 23.45 21.75 15.9533203125 29.3427734375 15.95 40 15.952734375 50.6580078125 23.45 58.15 31.0423828125 65.74765625 41.7 65.75 48.7376953125 65.747265625 54.45 62.45 L 76.15 85.5 Q 76.26796875 85.6412109375 76.4 85.7 76.5693359375 85.7599609375 76.7 85.75 81.1939453125 85.53125 82.9 83.5 84.7708984375 81.51328125 83.7 77.7 M 51.75 29.9 Q 55.9521484375 34.107421875 55.95 40 55.9521484375 45.8923828125 51.75 50.05 47.5923828125 54.2521484375 41.7 54.25 35.807421875 54.2521484375 31.6 50.05 27.44765625 45.8923828125 27.45 40 27.44765625 34.107421875 31.6 29.9 35.807421875 25.74765625 41.7 25.75 47.5923828125 25.74765625 51.75 29.9 Z"></path>
			</svg>
			<span>Find food near you</span>
		</a>
	</p>
</nav>


	<nav class="map-filters"></nav>
	<div id="map" class="mapbox"></div>

	<!-- For map.js -->
	<script type="text/template" id="marker-template">
	<div class="marker">
		<img src="/assets/images/markers/dot.png" alt="" />
	</div>
	</script>

	<script type="text/template" id="popup-template">
	<div class="map-point-details">
		<h3><a href="/source"></a></h3>
		<p class="type"></p>
		<p class="address"></p>
		<p class="phone"></p>
		<h4>Hours</h4>
		<p class="hours"></p>
	</div>
	</script>

	<!-- Jim’s Google Maps API key -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP5KxqO9v1sLhXlkrG3vDiDdOJvYLJ0H4"></script>

	<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js"></script>
	<script>

	var MAP_START_POSITION = [-118.243683, 34.052235];

	var MAP_BOUNDS = [
		[-119.9442369,32.7089729], // Southwest coordinates
		[-116.63282912,35.8275538]  // Northeast coordinates
	];

	var MAP_LAYERS = [
		{
			name: 'food-bank',
			label: 'Food Bank',
			sourceLayer: 'Food_Banks_-_Andrew',
			sourceURL: 'mapbox://fooddesertsla.c1nwj97w',
            // iconImage: '/assets/images/map/food-bank.svg',
			color: 'rgba(249, 192, 88, 0.75)' /* @banana */
		},
		{
			name: 'community-garden',
			label: 'Community Garden',
			sourceLayer: 'CG-UF-Nursery_-_Andrew',
			sourceURL: 'mapbox://fooddesertsla.5x93lfi1',
            // iconImage: '/assets/images/map/urban-farm.svg',
			color: 'rgba(144, 194, 70, 0.75)' /* @lime */
		},
		{
			name: 'farmers-market',
			label: 'Farmers’ Market',
			sourceLayer: 'Farmers_Markets_-_MASTER',
			sourceURL: 'mapbox://fooddesertsla.2ppvk6wg',
            // iconImage: '/assets/images/map/farmers-market.svg',
			color: 'rgba(241, 95, 91, 0.75)' /* @strawberry */
		},
		{
			name: 'grocery-store',
			label: 'Grocery Store',
			sourceLayer: 'Grocery_Stores_and_Supermarkets_',
			sourceURL: 'mapbox://fooddesertsla.3ow9v9cf',
            // iconImage: '/assets/images/map/grocery-store.svg',
			color: 'rgba(77, 85, 148, 0.35)' /* @blueberry */
		}
	];

	function getLayerLabel(name) {
		for (var index = 0; index < MAP_LAYERS.length; index++) {
			if (MAP_LAYERS[index].name === name) {
				return MAP_LAYERS[index].label;
			}
		}
	}

	function geocodeAddress(address, callback) {
		var geocoder = new google.maps.Geocoder();

		geocoder.geocode({'address': address}, function(results, status) {
			if (status === google.maps.GeocoderStatus.OK) {

				var longitude = results[0].geometry.location.lng();
				var latitude  = results[0].geometry.location.lat();

				callback([longitude, latitude]);

			} else {
				console.error('Geocode was not successful for the following reason: ' + status);
			}
		});
	}

	// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript#answer-901144
	function getParameterByName(name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	function findUserLocation() {
		var address = getParameterByName('address');

		if (address) {

			// Add Los Angeles to the address
			if (address.indexOf('Los Angeles') < 0) {
				address += ' Los Angeles';
			}

			geocodeAddress(address, moveMapToPosition);

		// Grab user's location on page-load
		} else if ("geolocation" in navigator) {
			navigator.geolocation.getCurrentPosition(function(position) {

				// Set new starting location
				var myCoords = [position.coords.longitude, position.coords.latitude];
				moveMapToPosition(myCoords)

			}, function() {
				console.error("Unable to retrieve your location");
			});
		}
	}

	function moveMapToPosition(position) {
		 map.setZoom(14);
		 map.panTo(position);

		// Add a marker at the user’s location
		var template = document.getElementById('marker-template');
		if (template) {
			var marker = document.createElement('div');
			marker.innerHTML = template.innerHTML;

			new mapboxgl.Marker(marker)
				.setLngLat(position)
				.addTo(map);
		}
	}

	var urlTag = getParameterByName('type');

	console.log(urlTag);

	var popup;
	function showPopup(event) {
		var layerNames = [];
		for (var i = 0; i < MAP_LAYERS.length; i++) {
			layerNames.push(MAP_LAYERS[i].name);
			layerNames.push(MAP_LAYERS[i].name + '-near');
			layerNames.push(MAP_LAYERS[i].name + '-far');
		}
		var features = map.queryRenderedFeatures(event.point, { 
			layers: layerNames
		});

		if (!popup) {
			popup = new mapboxgl.Popup({
				closeButton: false,
				closeOnClick: false
			});
		}

		// Change the cursor style as a UI indicator.
		map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
		if (!features.length) {
			popup.remove();
			return;
		}

		var feature = features[0];

		// TEMPORARY: Only show links to food banks (since the /source/ pages are only generated for food banks presently).
		var showLink = (feature.layer.id === 'food-bank') ? true : false;

		var element = createPopupElement(feature, showLink);

		popup.setLngLat(feature.geometry.coordinates).setDOMContent(element).addTo(map);
	}

	function createPopupElement(feature, showLink) {

		var template = document.getElementById('popup-template');
		if (template) {
			var element = document.createElement('div');
			element.innerHTML = template.innerHTML;

			var data = getFeatureData(feature);

			// Name
			var nameElement = element.querySelector('h3');
			if (showLink) {
				var link = nameElement.querySelector('a');
				link.setAttribute('href', link.getAttribute('href') + '/' + data.uri);
				link.innerHTML = data.name;
			} else {
				nameElement.innerHTML = data.name;
			}

			// Type
			var typeElement = element.querySelector('.type');
			typeElement.innerHTML = data.type;
			// typeElement.className += ' ' + type;

			// Address
			if (data.address) element.querySelector('.address').innerHTML = data.address;

			// Phone
			if (data.phone) element.querySelector('.phone').innerHTML = data.phone;

			// Hours
			var hoursElement = element.querySelector('.hours');
			if (data.hours) {
				hoursElement.innerHTML = data.hours;
			} else {
				var h4 = element.querySelector('h4');
				h4.parentNode.removeChild(h4);

				hoursElement.parentNode.removeChild(hoursElement);
			}

			return element;
		}
	}

	function getFeatureData(feature) {

		var data = {
			name:   feature.properties["name"] || 
					feature.properties["Name"] ||
					feature.properties["NAME"] ||
					feature.properties["NAME:"] ||
					feature.properties["MarketName"],
			type:   getLayerLabel(feature.layer.id.replace('-near', '').replace('-far', '')),
			hours:  feature.properties["times"] ||
					feature.properties["Times"] ||
					feature.properties["TIMES"] ||
					feature.properties["TIMES:"],
			phone:  feature.properties["telephone"] ||
					feature.properties["Telephone"] ||
					feature.properties["CONTACT"] ||
					feature.properties["CONTACT:"],
			address: getFeatureAddress(feature)
		};

		data.uri = data.name.toLowerCase()
					.replace(/\s/g, '-')
					.replace(/\//g, '-')
					.replace(/\&/g, '-')
					.replace(/\./g, '-')
					.replace(/\'/g, '')
					.replace(/\-\-/g, '-');

		return data;
	}

	function getFeatureAddress(feature) {
		var address = "";

		var street = 
					feature.properties["address"] ||
					feature.properties["Address"] ||
					feature.properties["ADDRESS"] ||
					feature.properties["ADDRESS:"];
		var city = 
					feature.properties["city"] ||
					feature.properties["City"];
		var state = 
					feature.properties["state"] ||
					feature.properties["State"];

		if (street) 
				address += street;
		if (city)
				address += (street ? '<br />' : '') + city;
		if (state)
				address += (city ? ', ' : (street ? '<br />' : '')) + state;

		return address;
	}

	mapboxgl.accessToken = 'pk.eyJ1IjoiZm9vZGRlc2VydHNsYSIsImEiOiJjaXByOXRscnMwNzY1Zm5ub3YwYTd5Z3dsIn0.DWgUhgW32pVkybKx7cWWiw';
	var map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/fooddesertsla/cirso6vli0009gam85y4z56xz',
		zoom: 13, // starting zoom
		center: MAP_START_POSITION, // starting position
		maxBounds: MAP_BOUNDS
	});

	var nav = new mapboxgl.Navigation({position: 'bottom-left'}); // position is optional
	map.addControl(nav);

	// Add 'Current Location' Functionality
	map.addControl(new mapboxgl.Geolocate());

	map.on('click', showPopup); 

	function addLayer(data, markerSize, minzoom, maxzoom) {
		var name = data.name + (!minzoom ? '-far' : (!maxzoom ? '-near' : ''));
		console.log('id: ' + name);
		map.addSource(name, {
			type: 'vector',
			url: data.sourceURL
		});
		var layerData = {
			'id': name,
			'type': 'circle',
			'source': name,
			'layout': {
				'visibility': 'visible'
                // 'icon-image': data.iconImage
			},
			'paint': {
				'circle-radius': markerSize,
				'circle-color': data.color
			},
			'source-layer': data.sourceLayer
		};
		if (minzoom) layerData.minzoom = minzoom;
		if (maxzoom) layerData.maxzoom = maxzoom;
		map.addLayer(layerData);
	}

	map.on('load', function () {
		for (var index = 0; index < MAP_LAYERS.length; index++) {
			addLayer(MAP_LAYERS[index], 9, 14, null); // Zoomed in
			addLayer(MAP_LAYERS[index], 6, 12, 14);
			addLayer(MAP_LAYERS[index], 3, null, 12); // Zoomed out
		}

		/*
		map.addSource('Census Tracts', {
			type: 'vector',
			url: 'mapbox://fooddesertsla.26tf3nay'
		});
		map.addLayer({
			'id': 'Census Tracts',
			'type': 'line',
			'source': 'Census Tracts',
			'layout': {
				'visibility': 'visible',
				'line-join': 'round',
				'line-cap': 'round'
			},
			'paint': {
				'line-color': '#877b59',
				'line-width': 1
			},
			'source-layer': 'LI_LA_Desert_Map_-_USDA_-_Tracts'
		});

		map.addSource('Food Deserts', {
			type: 'vector',
			url: 'mapbox://fooddesertsla.26tf3nay'
		});
		map.addLayer({
			'id': 'Food Deserts',
			'type': 'fill',
			'source': 'Food Deserts',
			'layout': {
				'visibility': 'visible'
			},
			'paint': {
				'fill-color': '#877b59'
			},
			'filter': ["==", "LI LA De_4", "1"],
			'source-layer': 'LI_LA_Desert_Map_-_USDA_-_Tracts'
		});
		*/

		findUserLocation();

		//var toggleableLayerIds = [ 'Grocery Stores', 'Farmers Markets', 'Food Banks', 'Community Gardens', 'Census Tracts', 'Food Deserts'];

		var layers = document.querySelector('.map-filters');
		function createButton(data) {

			var button = document.createElement('button');
			button.type = "button";
			button.className = data.name;
			button.textContent = data.label + 's'; // SHIM: Pluralize

			button.addEventListener('click', function(e) {
				e.preventDefault();

				var visibility = map.getLayoutProperty(data.name, 'visibility');

				if (visibility === 'visible') {
					map.setLayoutProperty(data.name, 'visibility', 'none');
					map.setLayoutProperty(data.name + '-near', 'visibility', 'none');
					map.setLayoutProperty(data.name + '-far', 'visibility', 'none');
					this.className += ' inactive';
				} else {
					map.setLayoutProperty(data.name, 'visibility', 'visible');
					map.setLayoutProperty(data.name + '-near', 'visibility', 'visible');
					map.setLayoutProperty(data.name + '-far', 'visibility', 'visible');
					this.className = this.className.replace(/inactive/g, '');
				}
			}, false);

			layers.appendChild(button);
		}

		for (var i = 0; i < MAP_LAYERS.length; i++) {
			createButton(MAP_LAYERS[i]);
		}
	});

	</script>

</body>
</html>
